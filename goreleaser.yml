version: 2

project_name: goconnect

env:
  - CGO_ENABLED=0
  - GO111MODULE=on

before:
  hooks:
    - go mod tidy -C ./server
    - go mod tidy -C ./client-daemon

# =============================================================================
# BUILDS - Cross-compile for all platforms
# =============================================================================
builds:
  # Server Build
  - id: server
    dir: ./server
    main: ./cmd/server/main.go
    binary: goconnect-server
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64 # Windows ARM64 is rare for servers

  # Client Daemon Build
  - id: daemon
    dir: ./client-daemon
    main: ./cmd/daemon/main.go
    binary: goconnect-daemon
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64 # Match server build for archive consistency

# =============================================================================
# ARCHIVES - Portable versions with installers
# =============================================================================
archives:
  # Server Archive (portable)
  - id: server-archive
    ids:
      - server
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip
    name_template: "goconnect-server_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - docs/ADMIN_GUIDE.md
      - docker-compose.yml

  # Daemon Archive with install scripts (portable + easy install)
  - id: daemon-archive
    ids:
      - daemon
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip
    name_template: "goconnect-daemon_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: client-daemon/service/linux/*
        dst: install/linux
        strip_parent: true
      - src: client-daemon/service/macos/*
        dst: install/macos
        strip_parent: true
      - src: client-daemon/service/windows/*
        dst: install/windows
        strip_parent: true

  # NOTE: Bundle removed to reduce asset count. Users can download server + daemon separately.

# =============================================================================
# LINUX PACKAGES - .deb and .rpm with systemd
# =============================================================================
nfpms:
  # Server Package
  - id: server-pkg
    package_name: goconnect-server
    ids:
      - server
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Server - VPN Management Server
      Provides REST API, WebSocket, and WireGuard management.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    recommends:
      - postgresql
      - redis
    bindir: /usr/local/bin
    contents:
      - src: docker-compose.yml
        dst: /etc/goconnect/docker-compose.yml
        type: config
      - dst: /var/log/goconnect
        type: dir
        file_info:
          mode: 0755

  # Daemon Package
  - id: daemon-pkg
    package_name: goconnect-daemon
    ids:
      - daemon
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Daemon - VPN Client Service
      Runs as a background service to manage WireGuard connections.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    bindir: /usr/local/bin
    contents:
      - src: client-daemon/service/linux/goconnect-daemon.service
        dst: /usr/lib/systemd/system/goconnect-daemon.service
        type: config
      - dst: /etc/goconnect
        type: dir
        file_info:
          mode: 0755
    scripts:
      postinstall: client-daemon/service/linux/postinstall.sh
      preremove: client-daemon/service/linux/preremove.sh

# =============================================================================
# CHECKSUMS - For verification
# =============================================================================
checksum:
  name_template: "checksums.txt"
  algorithm: sha256

# NOTE: SBOM removed to reduce asset count. Can be generated separately if needed.

# =============================================================================
# RELEASE - GitHub Release with detailed notes
# =============================================================================
release:
  github:
    owner: orhaniscoding
    name: goconnect
  draft: false
  prerelease: auto
  mode: replace
  name_template: "GoConnect v{{ .Version }}"
  header: |
    ## üöÄ GoConnect v{{ .Version }}

    **Release Date:** {{ .Date }}

    ---

    ## üìã Available Downloads

    | Component | Description | Platforms |
    |-----------|-------------|-----------|
    | **goconnect-server** | VPN management server with REST API | Linux, macOS, Windows |
    | **goconnect-daemon** | Client VPN daemon (background service) | Linux, macOS, Windows |

    ### üì¶ Package Types

    | Extension | Type | Best For |
    |-----------|------|----------|
    | `.deb` | Debian package | Ubuntu, Debian (auto-installs systemd service) |
    | `.rpm` | Red Hat package | RHEL, Fedora, CentOS (auto-installs systemd service) |
    | `.tar.gz` | Portable archive | macOS, Linux (includes install scripts) |
    | `.zip` | Portable archive | Windows (includes PowerShell install script) |

    ---

    ### What's Changed
    See [CHANGELOG.md](https://github.com/orhaniscoding/goconnect/blob/main/CHANGELOG.md) for full details.

  footer: |
    ---

    ## üì¶ Quick Start

    ### üñ•Ô∏è Server Setup (Self-Hosted)

    **Option 1: Docker (Recommended)**
    ```bash
    # Pull and run
    docker pull ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    docker run -d --name goconnect \
      -p 8080:8080 \
      -v goconnect-data:/data \
      ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    ```

    **Option 2: Linux Package**
    ```bash
    # Debian/Ubuntu
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo systemctl start goconnect-server

    # RHEL/Fedora
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo systemctl start goconnect-server
    ```

    ---

    ## üíª Client (Daemon) Installation

    ### üêß Linux

    **Debian/Ubuntu (.deb) - Recommended**
    ```bash
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo systemctl enable --now goconnect-daemon
    ```

    **RHEL/Fedora (.rpm)**
    ```bash
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo systemctl enable --now goconnect-daemon
    ```

    **Portable (.tar.gz)**
    ```bash
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.tar.gz
    tar -xzf goconnect-daemon_{{ .Version }}_linux_amd64.tar.gz
    cd goconnect-daemon_{{ .Version }}_linux_amd64
    sudo ./install/linux/goconnect-daemon.service  # Copy to systemd
    ```

    ### üçé macOS

    ```bash
    # Intel Mac
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_amd64.tar.gz

    # Apple Silicon (M1/M2/M3)
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_arm64.tar.gz

    # Extract and install
    tar -xzf goconnect-daemon_*.tar.gz
    cd goconnect-daemon_*
    sudo cp goconnect-daemon /usr/local/bin/
    sudo cp install/macos/com.goconnect.daemon.plist /Library/LaunchDaemons/
    sudo launchctl load /Library/LaunchDaemons/com.goconnect.daemon.plist
    ```

    ### ü™ü Windows

    **PowerShell (Run as Administrator)**
    ```powershell
    # Download
    Invoke-WebRequest -Uri "https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_windows_amd64.zip" -OutFile "goconnect-daemon.zip"

    # Extract and install
    Expand-Archive -Path "goconnect-daemon.zip" -DestinationPath "$env:ProgramFiles\GoConnect"
    cd "$env:ProgramFiles\GoConnect"
    .\install\windows\install.ps1
    ```

    ---

    ## üîê Verify Downloads

    ```bash
    # Download checksums
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/checksums.txt

    # Verify your download
    sha256sum -c checksums.txt --ignore-missing
    ```

    ---

    ## üìö Documentation

    - [Configuration Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/CONFIG_FLAGS.md)
    - [API Examples](https://github.com/orhaniscoding/goconnect/blob/main/docs/API_EXAMPLES.http)
    - [Security Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/SECURITY.md)

    ---

    **Full Changelog**: https://github.com/orhaniscoding/goconnect/compare/v{{ .PreviousTag }}...v{{ .Tag }}

# =============================================================================
# ANNOUNCE - Optional notifications
# =============================================================================
announce:
  skip: true # Enable when ready for Discord/Slack/etc notifications

