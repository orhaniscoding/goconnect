version: 2

project_name: goconnect

env:
  - CGO_ENABLED=0
  - GO111MODULE=on

before:
  hooks:
    - go mod tidy -C ./server
    - go mod tidy -C ./client-daemon

# =============================================================================
# BUILDS - Cross-compile for all platforms
# =============================================================================
builds:
  # Server Build
  - id: server
    dir: ./server
    main: ./cmd/server/main.go
    binary: goconnect-server
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64 # Windows ARM64 is rare for servers

  # Client Daemon Build
  - id: daemon
    dir: ./client-daemon
    main: ./cmd/daemon/main.go
    binary: goconnect-daemon
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64 # Match server build for archive consistency

# =============================================================================
# ARCHIVES - Portable versions with installers
# =============================================================================
archives:
  # Server Archive (portable)
  - id: server-archive
    ids:
      - server
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip
    name_template: "goconnect-server_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - docs/ADMIN_GUIDE.md
      - docker-compose.yml

  # Daemon Archive with install scripts (portable + easy install)
  - id: daemon-archive
    ids:
      - daemon
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip
    name_template: "goconnect-daemon_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: client-daemon/service/linux/*
        dst: install/linux
        strip_parent: true
      - src: client-daemon/service/macos/*
        dst: install/macos
        strip_parent: true
      - src: client-daemon/service/windows/*
        dst: install/windows
        strip_parent: true

  # NOTE: Bundle removed to reduce asset count. Users can download server + daemon separately.

# =============================================================================
# LINUX PACKAGES - .deb and .rpm with systemd
# =============================================================================
nfpms:
  # Server Package
  - id: server-pkg
    package_name: goconnect-server
    ids:
      - server
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Server - VPN Management Server
      Provides REST API, WebSocket, and WireGuard management.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    recommends:
      - postgresql
      - redis
    bindir: /usr/local/bin
    contents:
      - src: docker-compose.yml
        dst: /etc/goconnect/docker-compose.yml
        type: config
      - dst: /var/log/goconnect
        type: dir
        file_info:
          mode: 0755

  # Daemon Package
  - id: daemon-pkg
    package_name: goconnect-daemon
    ids:
      - daemon
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Daemon - VPN Client Service
      Runs as a background service to manage WireGuard connections.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    bindir: /usr/local/bin
    contents:
      - src: client-daemon/service/linux/goconnect-daemon.service
        dst: /usr/lib/systemd/system/goconnect-daemon.service
        type: config
      - dst: /etc/goconnect
        type: dir
        file_info:
          mode: 0755
    scripts:
      postinstall: client-daemon/service/linux/postinstall.sh
      preremove: client-daemon/service/linux/preremove.sh

# =============================================================================
# CHECKSUMS - For verification
# =============================================================================
checksum:
  name_template: "checksums.txt"
  algorithm: sha256

# NOTE: SBOM removed to reduce asset count. Can be generated separately if needed.

# =============================================================================
# RELEASE - GitHub Release with detailed notes
# =============================================================================
release:
  github:
    owner: orhaniscoding
    name: goconnect
  draft: false
  prerelease: auto
  mode: replace
  name_template: "GoConnect v{{ .Version }}"
  header: |
    ## üöÄ GoConnect v{{ .Version }}

    **Release Date:** {{ .Date }}

    ---

    ## üìã What's Included

    | File | Description | Platform |
    |------|-------------|----------|
    | `goconnect-server_*_linux_amd64.*` | VPN Server for 64-bit Linux (Intel/AMD) | Ubuntu, Debian, RHEL, Fedora |
    | `goconnect-server_*_linux_arm64.*` | VPN Server for ARM64 Linux | Raspberry Pi, AWS Graviton |
    | `goconnect-server_*_darwin_amd64.tar.gz` | VPN Server for Intel Mac | macOS 11+ |
    | `goconnect-server_*_darwin_arm64.tar.gz` | VPN Server for Apple Silicon | macOS 11+ (M1/M2/M3) |
    | `goconnect-server_*_windows_amd64.zip` | VPN Server for Windows | Windows 10/11, Server 2019+ |
    | `goconnect-daemon_*_linux_amd64.*` | VPN Client for 64-bit Linux | Ubuntu, Debian, RHEL, Fedora |
    | `goconnect-daemon_*_linux_arm64.*` | VPN Client for ARM64 Linux | Raspberry Pi, ARM servers |
    | `goconnect-daemon_*_darwin_amd64.tar.gz` | VPN Client for Intel Mac | macOS 11+ |
    | `goconnect-daemon_*_darwin_arm64.tar.gz` | VPN Client for Apple Silicon | macOS 11+ (M1/M2/M3) |
    | `goconnect-daemon_*_windows_amd64.zip` | VPN Client for Windows | Windows 10/11 |

    ### üì¶ File Extensions

    | Extension | Format | Auto-Install | Best For |
    |-----------|--------|--------------|----------|
    | `.deb` | Debian Package | ‚úÖ systemd service | Ubuntu, Debian, Linux Mint |
    | `.rpm` | Red Hat Package | ‚úÖ systemd service | RHEL, Fedora, CentOS, Rocky |
    | `.tar.gz` | Portable Archive | ‚ùå manual | macOS, Linux (any distro) |
    | `.zip` | Portable Archive | ‚ùå manual | Windows |
    | `checksums.txt` | SHA256 Hashes | - | Verify downloads |

    ---

    ### What's Changed
    See [CHANGELOG.md](https://github.com/orhaniscoding/goconnect/blob/main/CHANGELOG.md) for full details.

  footer: |
    ---

    ## üñ•Ô∏è Server Installation

    ### üê≥ Docker (Recommended - All Platforms)
    ```bash
    docker pull ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    docker run -d --name goconnect -p 8080:8080 -v goconnect-data:/data \
      -e JWT_SECRET=$(openssl rand -base64 32) \
      ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    ```

    ### üêß Linux Server
    ```bash
    # Debian/Ubuntu
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo systemctl enable --now goconnect-server

    # RHEL/Fedora/CentOS
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo systemctl enable --now goconnect-server
    ```

    ### üçé macOS Server
    ```bash
    # Download (Intel or Apple Silicon)
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_darwin_arm64.tar.gz
    tar -xzf goconnect-server_{{ .Version }}_darwin_arm64.tar.gz
    sudo cp goconnect-server /usr/local/bin/
    
    # Run
    JWT_SECRET=$(openssl rand -base64 32) goconnect-server
    ```

    ### ü™ü Windows Server (PowerShell as Admin)
    ```powershell
    Invoke-WebRequest -Uri "https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_windows_amd64.zip" -OutFile "server.zip"
    Expand-Archive -Path "server.zip" -DestinationPath "$env:ProgramFiles\GoConnect"
    # Run: & "$env:ProgramFiles\GoConnect\goconnect-server.exe"
    ```

    ---

    ## üíª Client (Daemon) Installation

    ### üêß Linux Client
    ```bash
    # Debian/Ubuntu (Recommended)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo systemctl enable --now goconnect-daemon

    # RHEL/Fedora/CentOS
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo systemctl enable --now goconnect-daemon

    # Portable (Any Linux)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.tar.gz
    tar -xzf goconnect-daemon_*.tar.gz && cd goconnect-daemon_*
    sudo cp goconnect-daemon /usr/local/bin/
    sudo cp install/linux/goconnect-daemon.service /etc/systemd/system/
    sudo systemctl enable --now goconnect-daemon
    ```

    ### üçé macOS Client
    ```bash
    # Intel Mac
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_amd64.tar.gz

    # Apple Silicon (M1/M2/M3)
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_arm64.tar.gz

    # Install
    tar -xzf goconnect-daemon_*.tar.gz && cd goconnect-daemon_*
    sudo cp goconnect-daemon /usr/local/bin/
    sudo cp install/macos/com.goconnect.daemon.plist /Library/LaunchDaemons/
    sudo launchctl load /Library/LaunchDaemons/com.goconnect.daemon.plist
    ```

    ### ü™ü Windows Client (PowerShell as Admin)
    ```powershell
    Invoke-WebRequest -Uri "https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_windows_amd64.zip" -OutFile "daemon.zip"
    Expand-Archive -Path "daemon.zip" -DestinationPath "$env:ProgramFiles\GoConnect"
    & "$env:ProgramFiles\GoConnect\install\windows\install.ps1"
    ```

    ---

    ## üîê Verify Downloads
    ```bash
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/checksums.txt
    sha256sum -c checksums.txt --ignore-missing  # Linux/macOS
    # Windows: Get-FileHash -Algorithm SHA256 <file> | Compare with checksums.txt
    ```

    ---

    ## üìö Documentation

    | Guide | Description |
    |-------|-------------|
    | [üì¶ Installation Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/INSTALLATION.md) | Complete setup for all platforms |
    | [‚öôÔ∏è Configuration](https://github.com/orhaniscoding/goconnect/blob/main/docs/CONFIG_FLAGS.md) | Environment variables & settings |
    | [üîê Security Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/SECURITY.md) | Production hardening |
    | [üì° API Reference](https://github.com/orhaniscoding/goconnect/blob/main/docs/API_EXAMPLES.http) | REST API examples |
    | [üë®‚Äçüíº Admin Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/ADMIN_GUIDE.md) | Dashboard & management |
    | [üóÑÔ∏è PostgreSQL Setup](https://github.com/orhaniscoding/goconnect/blob/main/docs/POSTGRESQL_SETUP.md) | Database configuration |
    | [üîë SSO & 2FA](https://github.com/orhaniscoding/goconnect/blob/main/docs/SSO_2FA.md) | Enterprise authentication |

    ---

    **Full Changelog**: https://github.com/orhaniscoding/goconnect/compare/v{{ .PreviousTag }}...v{{ .Tag }}

# =============================================================================
# ANNOUNCE - Optional notifications
# =============================================================================
announce:
  skip: true # Enable when ready for Discord/Slack/etc notifications

