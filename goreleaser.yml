version: 2

project_name: goconnect

env:
  - CGO_ENABLED=0
  - GO111MODULE=on

before:
  hooks:
    - go mod tidy -C ./server
    - go mod tidy -C ./client-daemon

# =============================================================================
# BUILDS - Cross-compile for all platforms
# =============================================================================
builds:
  # Server Build - Windows
  - id: server-windows
    dir: ./server
    main: ./cmd/server/main.go
    binary: goconnect-server
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - windows
    goarch:
      - amd64

  # Server Build - Linux
  - id: server-linux
    dir: ./server
    main: ./cmd/server/main.go
    binary: goconnect-server
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
    goarch:
      - amd64
      - arm64

  # Server Build - macOS
  - id: server-darwin
    dir: ./server
    main: ./cmd/server/main.go
    binary: goconnect-server
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - darwin
    goarch:
      - amd64
      - arm64

  # Client Daemon Build - Windows
  - id: daemon-windows
    dir: ./client-daemon
    main: ./cmd/daemon/main.go
    binary: goconnect-daemon
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - windows
    goarch:
      - amd64

  # Client Daemon Build - Linux
  - id: daemon-linux
    dir: ./client-daemon
    main: ./cmd/daemon/main.go
    binary: goconnect-daemon
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - linux
    goarch:
      - amd64
      - arm64

  # Client Daemon Build - macOS
  - id: daemon-darwin
    dir: ./client-daemon
    main: ./cmd/daemon/main.go
    binary: goconnect-daemon
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    goos:
      - darwin
    goarch:
      - amd64
      - arm64

# =============================================================================
# ARCHIVES - OS-specific packages with only relevant install files
# =============================================================================
archives:
  # Server Windows
  - id: server-windows-archive
    builds:
      - server-windows
    format: zip
    name_template: "goconnect-server_{{ .Version }}_windows_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: server/service/windows/*.ps1
        dst: .
        strip_parent: true
      - src: server/service/windows/README.md
        dst: .
        strip_parent: true

  # Server Linux
  - id: server-linux-archive
    builds:
      - server-linux
    format: tar.gz
    name_template: "goconnect-server_{{ .Version }}_linux_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: server/service/linux/*.sh
        dst: .
        strip_parent: true
      - src: server/service/linux/*.service
        dst: .
        strip_parent: true
      - src: server/service/linux/README.md
        dst: .
        strip_parent: true

  # Server macOS
  - id: server-darwin-archive
    builds:
      - server-darwin
    format: tar.gz
    name_template: "goconnect-server_{{ .Version }}_darwin_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: server/service/macos/*.sh
        dst: .
        strip_parent: true
      - src: server/service/macos/*.plist
        dst: .
        strip_parent: true
      - src: server/service/macos/README.md
        dst: .
        strip_parent: true

  # Daemon Windows
  - id: daemon-windows-archive
    builds:
      - daemon-windows
    format: zip
    name_template: "goconnect-daemon_{{ .Version }}_windows_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: client-daemon/service/windows/*.ps1
        dst: .
        strip_parent: true
      - src: client-daemon/service/windows/README.md
        dst: .
        strip_parent: true

  # Daemon Linux
  - id: daemon-linux-archive
    builds:
      - daemon-linux
    format: tar.gz
    name_template: "goconnect-daemon_{{ .Version }}_linux_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: client-daemon/service/linux/*.sh
        dst: .
        strip_parent: true
      - src: client-daemon/service/linux/*.service
        dst: .
        strip_parent: true
      - src: client-daemon/service/linux/README.md
        dst: .
        strip_parent: true

  # Daemon macOS
  - id: daemon-darwin-archive
    builds:
      - daemon-darwin
    format: tar.gz
    name_template: "goconnect-daemon_{{ .Version }}_darwin_{{ .Arch }}"
    files:
      - README.md
      - LICENSE
      - src: client-daemon/service/macos/*.sh
        dst: .
        strip_parent: true
      - src: client-daemon/service/macos/*.plist
        dst: .
        strip_parent: true
      - src: client-daemon/service/macos/README.md
        dst: .
        strip_parent: true

  # NOTE: Bundle removed to reduce asset count. Users can download server + daemon separately.

# =============================================================================
# LINUX PACKAGES - .deb and .rpm with systemd
# =============================================================================
nfpms:
  # Server Package
  - id: server-pkg
    package_name: goconnect-server
    builds:
      - server-linux
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Server - VPN Management Server
      Provides REST API, WebSocket, and WireGuard management.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    recommends:
      - postgresql
      - redis
    bindir: /usr/local/bin
    contents:
      - src: server/service/linux/goconnect-server.service
        dst: /usr/lib/systemd/system/goconnect-server.service
        type: config
      - src: docker-compose.yml
        dst: /etc/goconnect/docker-compose.yml
        type: config
      - dst: /var/log/goconnect
        type: dir
        file_info:
          mode: 0755
      - dst: /etc/goconnect
        type: dir
        file_info:
          mode: 0755
    scripts:
      postinstall: server/service/linux/postinstall.sh
      preremove: server/service/linux/preremove.sh

  # Daemon Package
  - id: daemon-pkg
    package_name: goconnect-daemon
    builds:
      - daemon-linux
    vendor: orhaniscoding
    homepage: https://github.com/orhaniscoding/goconnect
    maintainer: orhaniscoding <orhaniscoding@github.com>
    description: |
      GoConnect Daemon - VPN Client Service
      Runs as a background service to manage WireGuard connections.
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - wireguard-tools
    bindir: /usr/local/bin
    contents:
      - src: client-daemon/service/linux/goconnect-daemon.service
        dst: /usr/lib/systemd/system/goconnect-daemon.service
        type: config
      - dst: /etc/goconnect
        type: dir
        file_info:
          mode: 0755
    scripts:
      postinstall: client-daemon/service/linux/postinstall.sh
      preremove: client-daemon/service/linux/preremove.sh

# =============================================================================
# CHECKSUMS - For verification
# =============================================================================
checksum:
  name_template: "checksums.txt"
  algorithm: sha256

# NOTE: SBOM removed to reduce asset count. Can be generated separately if needed.

# =============================================================================
# RELEASE - GitHub Release with detailed notes
# =============================================================================
release:
  github:
    owner: orhaniscoding
    name: goconnect
  draft: false
  prerelease: auto
  mode: replace
  name_template: "GoConnect v{{ .Version }}"
  header: |
    ## üöÄ GoConnect v{{ .Version }}

    **Release Date:** {{ .Date }}

    ---

    ## üìã What's Included

    | File | Description | Platform |
    |------|-------------|----------|
    | `goconnect-server_*_linux_amd64.*` | VPN Server for 64-bit Linux (Intel/AMD) | Ubuntu, Debian, RHEL, Fedora |
    | `goconnect-server_*_linux_arm64.*` | VPN Server for ARM64 Linux | Raspberry Pi, AWS Graviton |
    | `goconnect-server_*_darwin_amd64.tar.gz` | VPN Server for Intel Mac | macOS 11+ |
    | `goconnect-server_*_darwin_arm64.tar.gz` | VPN Server for Apple Silicon | macOS 11+ (M1/M2/M3) |
    | `goconnect-server_*_windows_amd64.zip` | VPN Server for Windows | Windows 10/11, Server 2019+ |
    | `goconnect-daemon_*_linux_amd64.*` | VPN Client for 64-bit Linux | Ubuntu, Debian, RHEL, Fedora |
    | `goconnect-daemon_*_linux_arm64.*` | VPN Client for ARM64 Linux | Raspberry Pi, ARM servers |
    | `goconnect-daemon_*_darwin_amd64.tar.gz` | VPN Client for Intel Mac | macOS 11+ |
    | `goconnect-daemon_*_darwin_arm64.tar.gz` | VPN Client for Apple Silicon | macOS 11+ (M1/M2/M3) |
    | `goconnect-daemon_*_windows_amd64.zip` | VPN Client for Windows | Windows 10/11 |

    ### üì¶ File Extensions

    | Extension | Format | Auto-Install | Best For |
    |-----------|--------|--------------|----------|
    | `.deb` | Debian Package | ‚úÖ systemd service | Ubuntu, Debian, Linux Mint |
    | `.rpm` | Red Hat Package | ‚úÖ systemd service | RHEL, Fedora, CentOS, Rocky |
    | `.tar.gz` | Portable Archive | ‚ùå manual | macOS, Linux (any distro) |
    | `.zip` | Portable Archive | ‚ùå manual | Windows |
    | `checksums.txt` | SHA256 Hashes | - | Verify downloads |

    ---

    ### What's Changed
    See [CHANGELOG.md](https://github.com/orhaniscoding/goconnect/blob/main/CHANGELOG.md) for full details.

  footer: |
    ---

    ## üñ•Ô∏è Server Installation

    ### üê≥ Docker (Recommended - All Platforms)
    ```bash
    docker pull ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    docker run -d --name goconnect -p 8080:8080 -v goconnect-data:/data \
      -e JWT_SECRET=$(openssl rand -base64 32) \
      ghcr.io/orhaniscoding/goconnect-server:{{ .Version }}
    ```

    ### üêß Linux Server
    ```bash
    # Debian/Ubuntu (Recommended)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-server_{{ .Version }}_linux_amd64.deb
    sudo systemctl enable --now goconnect-server

    # RHEL/Fedora/CentOS
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-server_{{ .Version }}_linux_amd64.rpm
    sudo systemctl enable --now goconnect-server

    # Portable (Any Linux)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_linux_amd64.tar.gz
    tar -xzf goconnect-server_*.tar.gz
    cd goconnect-server_*_linux_*
    sudo ./install.sh
    ```

    ### üçé macOS Server
    ```bash
    # Download (Intel or Apple Silicon)
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_darwin_arm64.tar.gz
    tar -xzf goconnect-server_*.tar.gz
    cd goconnect-server_*_darwin_*
    sudo ./install.sh
    ```

    ### ü™ü Windows Server (PowerShell as Admin)
    ```powershell
    # Download
    Invoke-WebRequest -Uri "https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-server_{{ .Version }}_windows_amd64.zip" -OutFile "server.zip"

    # Extract and install
    Expand-Archive -Path "server.zip" -DestinationPath "goconnect-server"
    cd goconnect-server
    .\install.ps1
    ```

    ---

    ## üíª Client (Daemon) Installation

    ### üêß Linux Client
    ```bash
    # Debian/Ubuntu (Recommended)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo dpkg -i goconnect-daemon_{{ .Version }}_linux_amd64.deb
    sudo systemctl enable --now goconnect-daemon

    # RHEL/Fedora/CentOS
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo rpm -i goconnect-daemon_{{ .Version }}_linux_amd64.rpm
    sudo systemctl enable --now goconnect-daemon

    # Portable (Any Linux)
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_linux_amd64.tar.gz
    tar -xzf goconnect-daemon_*.tar.gz
    cd goconnect-daemon_*_linux_*
    sudo ./install.sh
    ```

    ### üçé macOS Client
    ```bash
    # Intel Mac
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_amd64.tar.gz

    # Apple Silicon (M1/M2/M3)
    curl -LO https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_darwin_arm64.tar.gz

    # Install
    tar -xzf goconnect-daemon_*.tar.gz
    cd goconnect-daemon_*_darwin_*
    sudo ./install.sh
    ```

    ### ü™ü Windows Client (PowerShell as Admin)
    ```powershell
    # Download
    Invoke-WebRequest -Uri "https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/goconnect-daemon_{{ .Version }}_windows_amd64.zip" -OutFile "daemon.zip"

    # Extract and install
    Expand-Archive -Path "daemon.zip" -DestinationPath "goconnect-daemon"
    cd goconnect-daemon
    .\install.ps1
    ```

    ---

    ## üîê Verify Downloads
    ```bash
    wget https://github.com/orhaniscoding/goconnect/releases/download/v{{ .Version }}/checksums.txt
    sha256sum -c checksums.txt --ignore-missing  # Linux/macOS
    # Windows: Get-FileHash -Algorithm SHA256 <file> | Compare with checksums.txt
    ```

    ---

    ## üìö Documentation

    | Guide | Description |
    |-------|-------------|
    | [üì¶ Installation Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/INSTALLATION.md) | Complete setup for all platforms |
    | [‚öôÔ∏è Configuration](https://github.com/orhaniscoding/goconnect/blob/main/docs/CONFIG_FLAGS.md) | Environment variables & settings |
    | [üîê Security Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/SECURITY.md) | Production hardening |
    | [üì° API Reference](https://github.com/orhaniscoding/goconnect/blob/main/docs/API_EXAMPLES.http) | REST API examples |
    | [üë®‚Äçüíº Admin Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/ADMIN_GUIDE.md) | Dashboard & management |
    | [üóÑÔ∏è PostgreSQL Setup](https://github.com/orhaniscoding/goconnect/blob/main/docs/POSTGRESQL_SETUP.md) | Database configuration |
    | [üîë SSO & 2FA](https://github.com/orhaniscoding/goconnect/blob/main/docs/SSO_2FA.md) | Enterprise authentication |

    ---

    **Full Changelog**: https://github.com/orhaniscoding/goconnect/compare/v{{ .PreviousTag }}...v{{ .Tag }}

# =============================================================================
# ANNOUNCE - Optional notifications
# =============================================================================
announce:
  skip: true # Enable when ready for Discord/Slack/etc notifications

