name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_SERVER: ${{ github.repository }}-server

jobs:
  # ============================================
  # BUILD DESKTOP APP (Tauri)
  # ============================================
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'x86_64'
          - platform: 'ubuntu-22.04'
            args: ''
            arch: 'amd64'
          - platform: 'windows-latest'
            args: ''
            arch: 'x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf protobuf-compiler

      - name: Install protoc (macOS)
        if: matrix.platform == 'macos-latest'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: matrix.platform == 'windows-latest'
        run: choco install protoc

      - name: Install frontend dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          args: ${{ matrix.args }}

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            desktop/src-tauri/target/release/bundle/**/*.dmg
            desktop/src-tauri/target/release/bundle/**/*.app
            desktop/src-tauri/target/release/bundle/**/*.deb
            desktop/src-tauri/target/release/bundle/**/*.AppImage
            desktop/src-tauri/target/release/bundle/**/*.exe
            desktop/src-tauri/target/release/bundle/**/*.msi
            desktop/src-tauri/target/**/release/bundle/**/*.dmg
            desktop/src-tauri/target/**/release/bundle/**/*.deb
            desktop/src-tauri/target/**/release/bundle/**/*.AppImage
            desktop/src-tauri/target/**/release/bundle/**/*.exe
            desktop/src-tauri/target/**/release/bundle/**/*.msi

  # ============================================
  # BUILD CLI (Terminal TUI App)
  # ============================================
  build-cli:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: cli/go.mod

      - name: Build CLI Binaries
        run: |
          mkdir -p dist
          VERSION=${{ github.ref_name }}
          
          # Linux
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-cli_${VERSION}_linux_amd64 ./cmd/goconnect
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-cli_${VERSION}_linux_arm64 ./cmd/goconnect
          
          # macOS
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-cli_${VERSION}_darwin_amd64 ./cmd/goconnect
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-cli_${VERSION}_darwin_arm64 ./cmd/goconnect
          
          # Windows
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-cli_${VERSION}_windows_amd64.exe ./cmd/goconnect
          
          # Create archives
          cd dist
          for f in goconnect-cli_*_linux_* goconnect-cli_*_darwin_*; do
            [ -f "$f" ] && tar -czvf "${f}.tar.gz" "$f" && rm "$f"
          done
          for f in goconnect-cli_*_windows_*.exe; do
            [ -f "$f" ] && zip "${f%.exe}.zip" "$f" && rm "$f"
          done
        working-directory: cli

      - name: Upload CLI Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-binaries
          path: cli/dist/

  # ============================================
  # BUILD SERVER (Self-hosted backend)
  # ============================================
  build-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: core/go.mod

      - name: Build Server Binaries
        run: |
          mkdir -p dist
          VERSION=${{ github.ref_name }}
          
          # Linux
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-server_${VERSION}_linux_amd64 ./cmd/server
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-server_${VERSION}_linux_arm64 ./cmd/server
          
          # macOS  
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-server_${VERSION}_darwin_amd64 ./cmd/server
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-server_${VERSION}_darwin_arm64 ./cmd/server
          
          # Windows
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/goconnect-server_${VERSION}_windows_amd64.exe ./cmd/server
          
          # Create archives
          cd dist
          for f in goconnect-server_*_linux_* goconnect-server_*_darwin_*; do
            [ -f "$f" ] && tar -czvf "${f}.tar.gz" "$f" && rm "$f"
          done
          for f in goconnect-server_*_windows_*.exe; do
            [ -f "$f" ] && zip "${f%.exe}.zip" "$f" && rm "$f"
          done
        working-directory: core

      - name: Upload Server Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-binaries
          path: core/dist/

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-desktop, build-cli, build-server]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Copy CLI binaries
          cp artifacts/cli-binaries/* release/ 2>/dev/null || true
          
          # Copy Server binaries
          cp artifacts/server-binaries/* release/ 2>/dev/null || true
          
          # Copy Desktop artifacts (flatten structure)
          find artifacts -name "*.dmg" -exec cp {} release/ \; 2>/dev/null || true
          find artifacts -name "*.deb" -exec cp {} release/ \; 2>/dev/null || true
          find artifacts -name "*.AppImage" -exec cp {} release/ \; 2>/dev/null || true
          find artifacts -name "*.msi" -exec cp {} release/ \; 2>/dev/null || true
          find artifacts -name "*_x64-setup.exe" -exec cp {} release/ \; 2>/dev/null || true
          find artifacts -name "*_x64_en-US.msi" -exec cp {} release/ \; 2>/dev/null || true
          
          # Generate checksums
          cd release
          sha256sum * > checksums.txt 2>/dev/null || true
          
          # List files for debugging
          echo "Release files:"
          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: GoConnect ${{ github.ref_name }}
          body: |
            # üöÄ GoConnect ${{ github.ref_name }}
            
            **Virtual LAN made simple** - Connect devices as if they're on the same local network
            
            ---
            
            ## üì¶ Downloads
            
            ### üñ•Ô∏è Desktop Application (Recommended)
            
            The easiest way to use GoConnect! Full GUI with all features.
            
            | Platform | Download | Notes |
            |----------|----------|-------|
            | **Windows** | `GoConnect_*_x64-setup.exe` | Recommended installer |
            | **Windows (MSI)** | `GoConnect_*_x64_en-US.msi` | For enterprise deployment |
            | **macOS (Apple Silicon)** | `GoConnect_*_aarch64.dmg` | M1/M2/M3 Macs |
            | **macOS (Intel)** | `GoConnect_*_x64.dmg` | Intel Macs |
            | **Linux (Debian/Ubuntu)** | `GoConnect_*_amd64.deb` | `sudo dpkg -i *.deb` |
            | **Linux (Universal)** | `GoConnect_*_amd64.AppImage` | Works on any distro |
            
            ### üíª Terminal Application (CLI)
            
            For command-line users and servers. Interactive TUI interface.
            
            | Platform | Download |
            |----------|----------|
            | Linux (x64) | `goconnect-cli_*_linux_amd64.tar.gz` |
            | Linux (ARM64) | `goconnect-cli_*_linux_arm64.tar.gz` |
            | macOS (Apple Silicon) | `goconnect-cli_*_darwin_arm64.tar.gz` |
            | macOS (Intel) | `goconnect-cli_*_darwin_amd64.tar.gz` |
            | Windows | `goconnect-cli_*_windows_amd64.zip` |
            
            ### üñß Server (Self-Hosted)
            
            For running your own GoConnect infrastructure.
            
            | Platform | Download |
            |----------|----------|
            | Linux (x64) | `goconnect-server_*_linux_amd64.tar.gz` |
            | Linux (ARM64) | `goconnect-server_*_linux_arm64.tar.gz` |
            | Docker | `ghcr.io/orhaniscoding/goconnect-server:${{ github.ref_name }}` |
            
            ---
            
            ## üöÄ Quick Start
            
            ### Desktop App
            1. Download the installer for your platform
            2. Install and open GoConnect
            3. Click "Create Network" or "Join Network"
            4. Share invite link with friends!
            
            ### CLI
            ```bash
            # Download and extract
            tar -xzf goconnect-cli_*_linux_amd64.tar.gz
            
            # Run interactive mode
            ./goconnect-cli
            
            # Or quick commands
            ./goconnect-cli create "My Network"
            ./goconnect-cli join gc://invite.goconnect.io/abc123
            ```
            
            ---
            
            ## üîê Verify Downloads
            
            ```bash
            sha256sum -c checksums.txt
            ```
            
            ---
            
            ## üìö Documentation
            
            - [Quick Start Guide](https://github.com/orhaniscoding/goconnect/blob/main/QUICK_START.md)
            - [User Guide](https://github.com/orhaniscoding/goconnect/blob/main/docs/USER_GUIDE.md)
            - [Architecture](https://github.com/orhaniscoding/goconnect/blob/main/docs/ARCHITECTURE.md)
            
            ---
            
            Built with ‚ù§Ô∏è by [@orhaniscoding](https://github.com/orhaniscoding)
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # BUILD DOCKER IMAGES
  # ============================================
  build-docker:
    runs-on: ubuntu-latest
    needs: [build-server]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Server
        uses: docker/build-push-action@v5
        with:
          context: ./core
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}:latest
          build-args: |
            VERSION=${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
