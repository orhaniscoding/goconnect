name: Backend Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'core/**'
      - 'cli/**'
      - 'go.work'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'core/**'
      - 'cli/**'
      - 'go.work'

jobs:
  test-core:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./core

    steps:
    - uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: core/go.sum

    - name: Verify dependencies
      run: go mod verify

    - name: Run Tests
      # Run tests with race detector, skipping long running integration tests if desired
      run: go test -v -race -short ./...

    - name: Validate Migrations Syntax
      # Check all migration files are valid SQL
      run: |
        for f in migrations/*.sql; do
          echo "Checking $f..."
          head -1 "$f" | grep -qE "^(--|CREATE|ALTER|DROP|INSERT|UPDATE|DELETE)" || {
            echo "ERROR: $f doesn't start with valid SQL statement"
            exit 1
          }
        done
        echo "All migration files validated!"

  test-cli:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./cli

    steps:
    - uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: cli/go.sum

    - name: Verify dependencies
      run: go mod verify

    - name: Run Tests
      run: go test -v -race -short ./...
