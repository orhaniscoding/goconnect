openapi: 3.1.0
info:
  title: GoConnect API
  version: 0.1.0
  description: GoConnect server API for virtual network management
  contact:
    name: GoConnect
    url: https://github.com/orhaniscoding/goconnect

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      description: Unique key for idempotent operations (24h TTL)
      schema:
        type: string
        format: uuid
        example: 550e8400-e29b-41d4-a716-446655440000
  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          example: ERR_NOT_AUTHORIZED
        message:
          type: string
          example: Authorization header required
        details:
          type: object
          additionalProperties: true
          description: Optional machine-readable error details

    Network:
      type: object
      required:
        [
          id,
          tenant_id,
          name,
          visibility,
          join_policy,
          cidr,
          created_by,
          created_at,
          updated_at,
        ]
      properties:
        id:
          type: string
          example: net_1234567890_123456
          description: Unique network identifier
        tenant_id:
          type: string
          example: default
          description: Tenant identifier
        name:
          type: string
          minLength: 3
          maxLength: 64
          example: My Private Network
          description: Human-readable network name
        visibility:
          type: string
          enum: [public, private]
          example: public
          description: Network visibility level
        join_policy:
          type: string
          enum: [open, invite, approval]
          example: open
          description: How users can join the network
        cidr:
          type: string
          pattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$'
          example: 10.0.0.0/24
          description: Network CIDR range
        dns:
          type: [string, "null"]
          example: 1.1.1.1
          description: Custom DNS server
        mtu:
          type: [integer, "null"]
          minimum: 576
          maximum: 1500
          example: 1420
          description: Maximum transmission unit
        split_tunnel:
          type: [boolean, "null"]
          example: false
          description: Enable split tunneling
        created_by:
          type: string
          example: user_123
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    NetworkListResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Network"
        pagination:
          type: object
          properties:
            limit:
              type: integer
              example: 20
            next_cursor:
              type: [string, "null"]
              example: net_1234567890_123456

    NetworkResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/Network"

    CreateNetworkRequest:
      type: object
      required: [name, visibility, join_policy, cidr]
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 64
        visibility:
          type: string
          enum: [public, private]
        join_policy:
          type: string
          enum: [open, invite, approval]
        cidr:
          type: string
        dns:
          type: [string, "null"]
        mtu:
          type: [integer, "null"]
        split_tunnel:
          type: [boolean, "null"]
      additionalProperties: false

    NetworkUpdateRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 64
        visibility:
          type: string
          enum: [public, private]
        join_policy:
          type: string
          enum: [open, invite, approval]
      additionalProperties: false

    Membership:
      type: object
      required: [id, network_id, user_id, role, status, created_at, updated_at]
      properties:
        id:
          type: string
        network_id:
          type: string
        user_id:
          type: string
        role:
          type: string
          enum: [member, admin, owner]
        status:
          type: string
          enum: [pending, approved, banned]
        joined_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    JoinRequest:
      type: object
      required: [id, network_id, user_id, status, created_at]
      properties:
        id:
          type: string
        network_id:
          type: string
        user_id:
          type: string
        status:
          type: string
          enum: [pending, approved, denied]
        created_at:
          type: string
          format: date-time
        decided_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"

    User:
      type: object
      required: [id, tenant_id, email, locale, is_admin, created_at, updated_at]
      properties:
        id:
          type: string
          example: usr_1234567890_123456
          description: Unique user identifier
        tenant_id:
          type: string
          example: tnt_1234567890_123456
          description: User's tenant identifier
        email:
          type: string
          format: email
          example: user@example.com
          description: User's email address
        locale:
          type: string
          enum:
            - en
            - tr
          example: en
          description: User's preferred language
        is_admin:
          type: boolean
          example: false
          description: Global admin flag
        created_at:
          type: string
          format: date-time
          example: "2025-10-29T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-29T10:00:00Z"

    AuthResponse:
      type: object
      required: [access_token, refresh_token, expires_in, token_type, user]
      properties:
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
          description: JWT access token (15 minutes)
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
          description: JWT refresh token (7 days)
        expires_in:
          type: integer
          example: 900
          description: Access token expiration in seconds
        token_type:
          type: string
          example: Bearer
          description: Token type for Authorization header
        user:
          $ref: "#/components/schemas/User"

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: newuser@example.com
          description: User's email address
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 72
          example: securePassword123
          description: User's password (8-72 characters)
        locale:
          type: string
          enum:
            - en
            - tr
          example: en
          description: Preferred language (default - en)

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: user@example.com
          description: User's email address
        password:
          type: string
          format: password
          example: securePassword123
          description: User's password

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
          description: Refresh token from previous authentication

    MembersListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Membership"
        pagination:
          type: object
          properties:
            limit:
              type: integer
            next_cursor:
              type: [string, "null"]

    # GDPR/DSR Schemas
    GDPRExportData:
      type: object
      description: Complete user data export for GDPR compliance
      required: [exported_at, user, devices, memberships, networks_owned]
      properties:
        exported_at:
          type: string
          format: date-time
          description: When the export was generated
        user:
          $ref: "#/components/schemas/GDPRUserData"
        devices:
          type: array
          items:
            $ref: "#/components/schemas/GDPRDeviceData"
        memberships:
          type: array
          items:
            $ref: "#/components/schemas/GDPRMemberData"
        networks_owned:
          type: array
          items:
            $ref: "#/components/schemas/GDPRNetworkData"

    GDPRUserData:
      type: object
      required: [id, email, created_at, updated_at]
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        locale:
          type: string
          enum: [tr, en]
        two_fa_enabled:
          type: boolean
        auth_provider:
          type: string
          enum: [local, google, github, oidc]
        is_admin:
          type: boolean
        is_moderator:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    GDPRDeviceData:
      type: object
      required: [id, name, platform, public_key, created_at, last_seen, online]
      properties:
        id:
          type: string
        name:
          type: string
        platform:
          type: string
        public_key:
          type: string
        ip_address:
          type: string
        created_at:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        online:
          type: boolean

    GDPRMemberData:
      type: object
      required: [network_id, network_name, role, status]
      properties:
        network_id:
          type: string
        network_name:
          type: string
        role:
          type: string
          enum: [member, admin, owner]
        status:
          type: string
          enum: [pending, approved, banned]
        joined_at:
          type: string
          format: date-time

    GDPRNetworkData:
      type: object
      required: [id, name, cidr, visibility, join_policy, created_at]
      properties:
        id:
          type: string
        name:
          type: string
        cidr:
          type: string
        visibility:
          type: string
          enum: [public, private]
        join_policy:
          type: string
          enum: [open, invite, approval]
        created_at:
          type: string
          format: date-time

    GDPRDeleteRequest:
      type: object
      required: [id, user_id, status, requested_at]
      properties:
        id:
          type: string
          description: Unique deletion request identifier
        user_id:
          type: string
          description: User ID being deleted
        status:
          type: string
          enum: [pending, processing, completed, failed]
          description: Current status of the deletion request
        requested_at:
          type: string
          format: date-time
          description: When the deletion was requested
        completed_at:
          type: string
          format: date-time
          description: When the deletion was completed (if applicable)
        error:
          type: string
          description: Error message if deletion failed

    RequestDeletionRequest:
      type: object
      required: [confirmation]
      properties:
        confirmation:
          type: string
          description: Must be exactly 'DELETE MY ACCOUNT' to confirm deletion
          example: DELETE MY ACCOUNT

    # Invite Token Schemas
    InviteToken:
      type: object
      required:
        [
          id,
          network_id,
          token,
          invite_url,
          expires_at,
          uses_max,
          uses_left,
          created_at,
          is_active,
        ]
      properties:
        id:
          type: string
          description: Unique invite token identifier
          example: inv_1234567890_123456
        network_id:
          type: string
          description: Network this invite is for
        token:
          type: string
          description: The actual invite token string
        invite_url:
          type: string
          format: uri
          description: Full URL to join using this invite
        expires_at:
          type: string
          format: date-time
          description: When this invite expires
        uses_max:
          type: integer
          description: Maximum number of uses (0 = unlimited)
        uses_left:
          type: integer
          description: Remaining uses
        created_at:
          type: string
          format: date-time
        is_active:
          type: boolean
          description: Whether the invite is still valid

    CreateInviteRequest:
      type: object
      properties:
        expires_in:
          type: integer
          minimum: 60
          maximum: 604800
          description: Seconds until expiration (1 min to 7 days, default 24h)
          example: 86400
        uses_max:
          type: integer
          minimum: 0
          maximum: 100
          description: Maximum uses (0 = unlimited)
          example: 10

    ValidateInviteResponse:
      type: object
      properties:
        valid:
          type: boolean
        network_id:
          type: string
        expires_at:
          type: string
          format: date-time

    IPRule:
      type: object
      required: [id, tenant_id, type, cidr, created_by, created_at]
      properties:
        id:
          type: string
          description: Unique IP rule identifier
          example: ipr_1234567890_123456
        tenant_id:
          type: string
          description: Tenant this rule belongs to
        type:
          type: string
          enum: [allow, deny]
          description: Rule type (allow or deny)
        cidr:
          type: string
          description: IP address or CIDR range
          example: 192.168.1.0/24
        description:
          type: string
          description: Optional description of the rule
        created_by:
          type: string
          description: User ID who created this rule
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: Optional expiration time

    CreateIPRuleRequest:
      type: object
      required: [type, cidr]
      properties:
        type:
          type: string
          enum: [allow, deny]
          description: Rule type
        cidr:
          type: string
          description: IP address or CIDR range
          example: 192.168.1.0/24
        description:
          type: string
          maxLength: 256
          description: Optional description
        expires_at:
          type: string
          format: date-time
          description: Optional expiration time

    IPRulesListResponse:
      type: object
      properties:
        rules:
          type: array
          items:
            $ref: "#/components/schemas/IPRule"
        total:
          type: integer

    CheckIPRequest:
      type: object
      required: [ip]
      properties:
        ip:
          type: string
          description: IP address to check
          example: 192.168.1.50

    CheckIPResponse:
      type: object
      properties:
        allowed:
          type: boolean
          description: Whether the IP is allowed
        matched_rule:
          $ref: "#/components/schemas/IPRule"
          description: The rule that matched (if any)

paths:
  /v1/auth/register:
    post:
      summary: Register new user
      description: Create a new user account with email and password
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          description: Invalid request (email format, password length, duplicate email)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidEmail:
                  value:
                    code: ERR_INVALID_REQUEST
                    message: Email is required
                shortPassword:
                  value:
                    code: ERR_INVALID_REQUEST
                    message: Password must be at least 8 characters
                duplicateEmail:
                  value:
                    code: ERR_USER_ALREADY_EXISTS
                    message: A user with this email already exists
                    details:
                      email: user@example.com

  /v1/auth/login:
    post:
      summary: User login
      description: Authenticate with email and password
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                code: ERR_INVALID_CREDENTIALS
                message: Invalid email or password

  /v1/auth/refresh:
    post:
      summary: Refresh access token
      description: Get new access and refresh tokens using a valid refresh token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidToken:
                  value:
                    code: ERR_INVALID_TOKEN
                    message: Invalid token
                wrongType:
                  value:
                    code: ERR_INVALID_TOKEN
                    message: Token is not a refresh token

  /v1/auth/logout:
    post:
      summary: User logout
      description: Invalidate current session (placeholder - token revocation requires Redis)
      tags: [Authentication]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/audit/integrity:
    get:
      summary: Export audit integrity snapshot
      description: "Returns current audit hash chain head and recent anchor snapshots for remote verification."
      tags: [Audit]
      parameters:
        - name: anchors
          in: query
          description: Maximum number of recent anchors to include (ascending order)
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 20
      responses:
        "200":
          description: Integrity export
          content:
            application/json:
              schema:
                type: object
                properties:
                  head:
                    type: object
                    properties:
                      seq: { type: integer }
                      hash: { type: string }
                      ts: { type: string, format: date-time }
                  anchors:
                    type: array
                    items:
                      type: object
                      properties:
                        seq: { type: integer }
                        hash: { type: string }
                        ts: { type: string, format: date-time }
                  latest_seq: { type: integer }
                  earliest_seq: { type: integer }
                  generated_at: { type: string, format: date-time }
                  signature:
                    {
                      type: string,
                      description: "Base64URL Ed25519 signature over export JSON sans this field",
                    }
                  kid:
                    {
                      type: string,
                      description: "Signing key identifier (if present) included in signed payload",
                    }
        "501":
          description: Auditor does not support integrity export
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal error exporting integrity snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /v1/networks:
    get:
      summary: List networks
      description: "Retrieve networks based on visibility and filtering options"
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: visibility
          in: query
          description: "Filter by network visibility"
          schema:
            type: string
            enum: [public, mine, all]
            default: public
          example: "public"
        - name: limit
          in: query
          description: "Maximum number of networks to return"
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: cursor
          in: query
          description: "Pagination cursor"
          schema:
            type: string
          example: "net_1234567890_123456"
        - name: search
          in: query
          description: "Search networks by name"
          schema:
            type: string
          example: "private"
      responses:
        "200":
          description: "Networks retrieved successfully"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NetworkListResponse"
        "401":
          description: "Unauthorized"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: "Forbidden - insufficient privileges"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Create network
      description: "Create a new virtual network with CIDR validation and overlap detection"
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateNetworkRequest"
      responses:
        "201":
          description: "Network created successfully"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NetworkResponse"
        "400":
          description: "Bad request - validation error"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalid_cidr:
                  summary: Invalid CIDR format
                  value:
                    code: "ERR_CIDR_INVALID"
                    message: "Invalid CIDR format: invalid network address"
                    details:
                      field: "cidr"
        "401":
          description: "Unauthorized"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: "Conflict - CIDR overlap or idempotency conflict"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                cidr_overlap:
                  summary: CIDR overlap with existing network
                  value:
                    code: "ERR_CIDR_OVERLAP"
                    message: "CIDR range overlaps with existing network"
                    details:
                      cidr: "10.0.0.0/24"
                idempotency_conflict:
                  summary: Idempotency key reused with different body
                  value:
                    code: "ERR_IDEMPOTENCY_CONFLICT"
                    message: "Idempotency key already used with different request body"
                    details:
                      key: "550e8400-e29b-41d4-a716-446655440000"
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/networks/{id}:
    get:
      summary: Get network by ID
      description: "Retrieve a specific network by its ID"
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: "Network ID"
          schema:
            type: string
          example: "net_1234567890_123456"
      responses:
        "200":
          description: "Network retrieved successfully"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NetworkResponse"
        "401":
          description: "Unauthorized"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: "Network not found"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update network
      description: "Update mutable network fields (name, visibility, join_policy). RBAC: admin/owner (or global admin)."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NetworkUpdateRequest"
      responses:
        "200":
          {
            description: "Updated",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/NetworkResponse" } },
              },
          }
        "400":
          {
            description: "Invalid request",
            content:
              {
                application/json:
                  {
                    schema: { $ref: "#/components/schemas/Error" },
                    examples:
                      {
                        invalid:
                          {
                            value:
                              {
                                code: "ERR_INVALID_REQUEST",
                                message: "Invalid name length",
                              },
                          },
                      },
                  },
              },
          }
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                unauth:
                  value:
                    code: ERR_NOT_AUTHORIZED
                    message: Authorization header required
        "403":
          description: Not authorized (role)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                forbrbac:
                  value:
                    code: ERR_NOT_AUTHORIZED
                    message: Administrator privileges required
        "404":
          {
            description: "Not found",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
    delete:
      summary: Delete network
      description: "Soft delete a network. RBAC: admin/owner (or global admin)."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: "Deleted"
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "401":
          description: "Unauthorized"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: "Forbidden - insufficient privileges"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: "Network not found"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /v1/networks/{id}/ip-allocations:
    post:
      summary: Allocate or retrieve IP for current user
      description: "Returns existing allocation if one exists, otherwise allocates next available IP. Requires authentication; future versions will enforce approved membership."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: Allocation
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      network_id: { type: string }
                      user_id: { type: string }
                      ip: { type: string, example: "10.0.0.5" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not authorized (membership required or not approved)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_member:
                  value:
                    code: ERR_NOT_AUTHORIZED
                    message: Membership required to allocate IP
        "404":
          description: Network not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: IP space exhausted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                exhausted:
                  value:
                    code: ERR_IP_EXHAUSTED
                    message: No available IP addresses remaining
    get:
      summary: List IP allocations for the network
      description: "List all current IP allocations. Requires approved membership in the network."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Allocations listed
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        network_id: { type: string }
                        user_id: { type: string }
                        ip: { type: string, example: "10.0.0.5" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not authorized (membership required or not approved)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Network not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /v1/networks/{id}/ip-allocation:
    delete:
      summary: Release current user's IP allocation
      description: "Releases (frees) the caller's existing IP allocation if present. Idempotent: releasing a non-existent allocation returns 204. Requires approved membership."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "204": { description: Released (or no allocation existed) }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "403":
          description: Not authorized (membership required / not approved)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
              examples:
                not_member:
                  value:
                    code: ERR_NOT_AUTHORIZED
                    message: Membership required
        "404":
          description: Network not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /v1/networks/{id}/ip-allocations/{user_id}:
    delete:
      summary: Admin release another member's IP allocation
      description: "Admin or owner releases a target member's IP allocation. Idempotent: 204 even if target had no allocation. Both actor and target must be approved members; actor must have role admin or owner."
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "204": { description: Released (or no allocation existed) }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "403":
          description: Not authorized (admin/owner role or membership conditions failed)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
              examples:
                not_admin:
                  value:
                    code: ERR_NOT_AUTHORIZED
                    message: Admin or owner role required
        "404":
          description: Network not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  # Future: IP allocation endpoint (to be implemented)
  # /v1/networks/{id}/ip-allocations:
  #   post:
  #     summary: Allocate or retrieve IP for current user in network
  #     description: Returns existing allocation if present; otherwise allocates next available IP address.
  #     responses:
  #       '200':
  #         description: Allocation
  #         content:
  #           application/json:
  #             schema:
  #               type: object
  #               properties:
  #                 network_id:
  #                   type: string
  #                 user_id:
  #                   type: string
  #                 ip:
  #                   type: string
  #       '404':
  #         $ref: '#/components/responses/NotFound'
  #       '409':
  #         description: IP space exhausted
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/Error'
  #             examples:
  #               exhausted:
  #                 value:
  #                   code: ERR_IP_EXHAUSTED
  #                   message: No available IP addresses remaining

  /v1/networks/{id}/join:
    post:
      summary: Join a network
      description: "Join flow based on network join_policy"
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: "Joined as member"
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Membership"
        "202":
          description: "Join request created (approval policy)"
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/JoinRequest"
        "404":
          description: "Private network (hidden)"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/networks/{id}/approve:
    post:
      summary: Approve a pending join request
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        "200":
          description: "Approved membership"
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Membership"
        "400":
          description: "Invalid request"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: "Unauthorized"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: "Forbidden - only admin/owner can approve"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/networks/{id}/deny:
    post:
      summary: Deny a pending join request
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        "200":
          description: "Denied"
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "400":
          {
            description: "Invalid request",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "401":
          {
            description: "Unauthorized",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "403":
          {
            description: "Forbidden - only admin/owner can deny",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/networks/{id}/kick:
    post:
      summary: Kick an approved member
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        "200":
          description: "Kicked"
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "400":
          {
            description: "Invalid request",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "401":
          {
            description: "Unauthorized",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "403":
          {
            description: "Forbidden - only admin/owner can kick",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/networks/{id}/ban:
    post:
      summary: Ban a user from the network
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        "200":
          description: "Banned"
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "400":
          {
            description: "Invalid request",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "401":
          {
            description: "Unauthorized",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "403":
          {
            description: "Forbidden - only admin/owner can ban",
            content:
              {
                application/json:
                  { schema: { $ref: "#/components/schemas/Error" } },
              },
          }
        "429":
          description: "Too Many Requests - Rate limit exceeded"
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /v1/networks/{id}/members:
    get:
      summary: List members
      tags: [Networks]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, approved, banned]
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - name: cursor
          in: query
          schema: { type: string }
      responses:
        "200":
          description: "Members listed"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MembersListResponse"

  /v1/admin/stats:
    get:
      summary: Get system statistics
      description: Retrieve system-wide statistics (Admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: System statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      total_users: { type: integer }
                      total_tenants: { type: integer }
                      total_networks: { type: integer }
                      total_devices: { type: integer }
                      active_connections: { type: integer }
                      messages_today: { type: integer }

  /v1/admin/users:
    get:
      summary: List users
      description: List all users with pagination and search (Admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: offset
          in: query
          schema: { type: integer, default: 0 }
        - name: q
          in: query
          description: Search query (email)
          schema: { type: string }
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
                  meta:
                    type: object
                    properties:
                      total: { type: integer }
                      limit: { type: integer }
                      offset: { type: integer }

  /v1/admin/tenants:
    get:
      summary: List tenants
      description: List all tenants with pagination and search (Admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: offset
          in: query
          schema: { type: integer, default: 0 }
        - name: q
          in: query
          description: Search query (name)
          schema: { type: string }
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        name: { type: string }
                        created_at: { type: string, format: date-time }
                        updated_at: { type: string, format: date-time }
                  meta:
                    type: object
                    properties:
                      total: { type: integer }
                      limit: { type: integer }
                      offset: { type: integer }

  /v1/admin/networks:
    get:
      summary: List all networks
      description: List all networks system-wide with pagination and search (Admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: cursor
          in: query
          schema: { type: string }
        - name: q
          in: query
          description: Search query (name or CIDR)
          schema: { type: string }
      responses:
        "200":
          description: List of networks
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListNetworksResponse"

  /v1/admin/devices:
    get:
      summary: List all devices
      description: List all devices system-wide with pagination and search (Admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: cursor
          in: query
          schema: { type: string }
        - name: q
          in: query
          description: Search query (name or hostname)
          schema: { type: string }
      responses:
        "200":
          description: List of devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Device"
                  meta:
                    type: object
                    properties:
                      limit: { type: integer }
                      next_cursor: { type: string }

  # GDPR/DSR Endpoints
  /v1/me/export:
    get:
      summary: Export user data
      description: |
        Export all personal data for the authenticated user (GDPR Article 20).
        Returns a JSON summary of user data including profile, devices, memberships, and owned networks.
      tags: [GDPR]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User data export summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GDPRExportData"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Export failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/me/export/download:
    get:
      summary: Download user data as JSON file
      description: |
        Download all personal data as a JSON file (GDPR Article 20).
        Returns a downloadable JSON file with Content-Disposition header.
      tags: [GDPR]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: JSON file download
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GDPRExportData"
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="user-data-export.json"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/me/delete:
    delete:
      summary: Request account deletion
      description: |
        Request deletion of all personal data (GDPR Article 17 - Right to Erasure).
        Requires explicit confirmation to prevent accidental deletion.
        The deletion is processed asynchronously by a background worker.
      tags: [GDPR]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RequestDeletionRequest"
      responses:
        "202":
          description: Deletion request accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GDPRDeleteRequest"
        "400":
          description: Invalid confirmation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # Invite Token Endpoints
  /v1/networks/{id}/invites:
    post:
      summary: Create invite token
      description: |
        Create a new invite token for a network.
        Requires admin or owner role in the network.
        Only works for networks with 'invite' or 'approval' join policy.
      tags: [Invites]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInviteRequest"
      responses:
        "201":
          description: Invite token created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InviteToken"
        "400":
          description: Invalid request (e.g., open network)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not authorized (requires admin/owner role)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      summary: List invite tokens
      description: List all active invite tokens for a network
      tags: [Invites]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of invite tokens
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/InviteToken"

  /v1/networks/{id}/invites/{invite_id}:
    get:
      summary: Get invite token details
      description: Get details of a specific invite token
      tags: [Invites]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: invite_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Invite token details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InviteToken"
        "404":
          description: Invite not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Revoke invite token
      description: Revoke an invite token so it can no longer be used
      tags: [Invites]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: invite_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Invite revoked
        "403":
          description: Not authorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Invite not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/invites/{token}/validate:
    get:
      summary: Validate invite token
      description: |
        Validate an invite token without using it.
        This is a public endpoint that doesn't require authentication.
      tags: [Invites]
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidateInviteResponse"

  /v1/admin/ip-rules:
    get:
      summary: List IP rules
      description: List all IP rules for the tenant
      tags: [IPRules]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of IP rules
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IPRulesListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create IP rule
      description: Create a new IP allow or deny rule
      tags: [IPRules]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateIPRuleRequest"
      responses:
        "201":
          description: IP rule created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IPRule"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - admin access required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/admin/ip-rules/{id}:
    get:
      summary: Get IP rule
      description: Get a specific IP rule by ID
      tags: [IPRules]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: IP rule details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IPRule"
        "404":
          description: IP rule not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete IP rule
      description: Delete an IP rule
      tags: [IPRules]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: IP rule deleted
        "404":
          description: IP rule not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/admin/ip-rules/check:
    post:
      summary: Check IP against rules
      description: Check if an IP address is allowed or denied by the current rules
      tags: [IPRules]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CheckIPRequest"
      responses:
        "200":
          description: Check result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckIPResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

tags:
  - name: Networks
    description: "Virtual network management operations"
  - name: GDPR
    description: "GDPR Data Subject Rights (DSR) endpoints"
  - name: Invites
    description: "Network invitation token management"
  - name: IPRules
    description: "IP allowlist/denylist management for tenant access control"
