---
description: Go security rules for GoConnect
globs: **/*.go
alwaysApply: true
---
# Secure Go Development for GoConnect

## 1. Decode Untrusted Data Safely
- Use strict JSON with size limits
- Reject unknown fields
- Avoid `encoding/gob` for untrusted input

```go
// ✅ Safe
dec := json.NewDecoder(http.MaxBytesReader(w, r.Body, 1<<20))
dec.DisallowUnknownFields()
var in Request
if err := dec.Decode(&in); err != nil { /* handle */ }
```

## 2. Use Parameterized Queries
- Never format SQL with user input
- Use placeholders and context with timeouts

```go
// ❌ Unsafe
query := fmt.Sprintf("SELECT * FROM users WHERE name = '%s'", name)

// ✅ Safe
ctx, cancel := context.WithTimeout(r.Context(), 3*time.Second)
defer cancel()
row := db.QueryRowContext(ctx, "SELECT id FROM users WHERE name = $1", name)
```

## 3. Prevent Command Injection
- Use `exec.CommandContext` with fixed program and separate args
- Validate inputs against allow lists

```go
// ❌ Unsafe
exec.Command("sh", "-c", "ls "+userArg).Run()

// ✅ Safe
cmd := exec.CommandContext(ctx, "ls", validatedArg)
```

## 4. File and Path Safety
- Block path traversal
- Restrict file permissions

```go
clean := filepath.Clean("/" + userRel)
full := filepath.Join(base, clean)
rel, err := filepath.Rel(base, full)
if err != nil || strings.HasPrefix(rel, "..") {
    return fmt.Errorf("outside base dir")
}
```

## 5. Secure HTTP Server Defaults
- Set timeouts, cap headers and bodies

```go
srv := &http.Server{
    ReadTimeout:       10 * time.Second,
    ReadHeaderTimeout: 5 * time.Second,
    WriteTimeout:      10 * time.Second,
    IdleTimeout:       60 * time.Second,
    MaxHeaderBytes:    1 << 20,
}
```

## 6. Log and Error Hygiene
- Do not log secrets, tokens, personal data
- Return generic error messages to clients

## 7. Strong Cryptography
- Use `crypto/rand` for secrets
- Do not hardcode keys
- Use Argon2id for password hashing

## 8. TLS and Outbound HTTP Safety
- Do not set `InsecureSkipVerify: true`
- Pin minimum TLS version to 1.2

## 9. JWT Validation
- Verify signature, issuer, audience, expiry
- Reject `alg: none`
- Prefer RS256 or EdDSA

## 10. Cookies and Sessions
- Set `Secure`, `HttpOnly`, `SameSite`
