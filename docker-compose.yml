# =============================================================================
# GoConnect - Development & Production Docker Compose
# =============================================================================
# Usage:
#   Development: docker compose up -d
#   Production:  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # GoConnect Server
  # ---------------------------------------------------------------------------
  server:
    build:
      context: ./core
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    image: ghcr.io/orhaniscoding/goconnect-server:${VERSION:-latest}
    container_name: goconnect-server
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8081}:8080"
    environment:
      # Server
      - SETUP_MODE=${SETUP_MODE:-false}
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - ENVIRONMENT=${ENVIRONMENT:-development}
      # Database
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-goconnect}
      - DB_USER=${DB_USER:-goconnect}
      - DB_PASSWORD=${DB_PASSWORD:-goconnect_secret}
      - DB_SSLMODE=${DB_SSLMODE:-disable}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # JWT (CHANGE IN PRODUCTION!)
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production-minimum-32-chars}
      - JWT_ACCESS_TTL=${JWT_ACCESS_TTL:-15m}
      - JWT_REFRESH_TTL=${JWT_REFRESH_TTL:-168h}
      # WireGuard
      - WG_INTERFACE_NAME=${WG_INTERFACE_NAME:-wg0}
      - WG_SERVER_ENDPOINT=${WG_SERVER_ENDPOINT:-vpn.example.com:51820}
      - WG_SERVER_PUBKEY=${WG_SERVER_PUBKEY:-OW1KlbS/keHDAAT7ps27ReCM5B4obISu7bV9uD2y3Rk=}
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY:-}
      - WG_DNS=${WG_DNS:-1.1.1.1,1.0.0.1}
      # OIDC (Optional)
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URL=${OIDC_REDIRECT_URL:-}
      # Audit
      - AUDIT_SQLITE_DSN=/data/audit.db
      - AUDIT_ASYNC=true
      # CORS
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
    volumes:
      - goconnect-data:/data
      - goconnect-logs:/var/log/goconnect
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - goconnect-net
    # Required for WireGuard management
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: goconnect-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${DB_NAME:-goconnect}
      - POSTGRES_USER=${DB_USER:-goconnect}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-goconnect_secret}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-goconnect} -d ${DB_NAME:-goconnect}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - goconnect-net
    # Uncomment to expose PostgreSQL externally (development only)
    # ports:
    #   - "5432:5432"

  # ---------------------------------------------------------------------------
  # Redis Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: goconnect-redis
    restart: unless-stopped
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - goconnect-net
    # Uncomment to expose Redis externally (development only)
    # ports:
    #   - "6379:6379"

  # ---------------------------------------------------------------------------
  # coturn TURN Server (NAT Traversal)
  # ---------------------------------------------------------------------------
  coturn:
    image: coturn/coturn:latest
    container_name: goconnect-coturn
    restart: unless-stopped
    ports:
      # TURN listening port (UDP primary, TCP fallback)
      - "${TURN_PORT:-3478}:3478/udp"
      - "${TURN_PORT:-3478}:3478/tcp"
      # TURN TLS port (optional, for secure connections)
      - "${TURN_TLS_PORT:-5349}:5349/udp"
      - "${TURN_TLS_PORT:-5349}:5349/tcp"
      # Relay ports range (for media relay)
      - "49152-49252:49152-49252/udp"
    environment:
      - TURN_SECRET=${TURN_SECRET:-change-me-in-production}
      - TURN_REALM=${TURN_REALM:-goconnect.io}
      - TURN_EXTERNAL_IP=${TURN_EXTERNAL_IP:-}
    volumes:
      - ./docker/coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    command: >
      -c /etc/coturn/turnserver.conf
      --static-auth-secret=${TURN_SECRET:-change-me-in-production}
      --realm=${TURN_REALM:-goconnect.io}
      ${TURN_EXTERNAL_IP:+--external-ip=${TURN_EXTERNAL_IP}}
    healthcheck:
      test: ["CMD", "turnutils_uclient", "-T", "-u", "test", "-w", "test", "127.0.0.1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - goconnect-net

# =============================================================================
# Networks
# =============================================================================
networks:
  goconnect-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  goconnect-data:
    driver: local
  goconnect-logs:
    driver: local